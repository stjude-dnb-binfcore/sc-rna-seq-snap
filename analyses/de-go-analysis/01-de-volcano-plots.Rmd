---
title: "Differential expression (DE) and Volcano plots Per Cell Type for sc-RNA-Seq Analysis in 10X Genomics data"
author: "Antonia Chroni for SJCRH DNB_BINF_Core"
papersize: a4
fontsize: 11pt
links-as-notes: true
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    df_print: paged
    code_folding: hide
    toc_depth: 2
    highlight: tango
    number_sections: TRUE
  pdf_document:
    toc: TRUE
    highlight: tango
    number_sections: TRUE
    latex_engine: lualatex
    keep_tex: FALSE
    fig_caption: yes
    fig_crop: no
    fig_height: 2
    fig_width: 3
    toc_depth: 2
always_allow_html: TRUE
urlcolor: blue
linkcolor: black
citecolor: blue
geometry: margin=1in
header-includes: 
  - \usepackage{titling}
  - \usepackage{fancyhdr}
  - \usepackage{graphicx}
  - \usepackage{float}
params:
  resolution_list: '.'
  n_value: '.'
  assay: '.'
  cell_type_label_go: '.'
  root_dir: './'
  PROJECT_NAME: '.'
  PI_NAME: '.'
  TASK_ID: '.'
  PROJECT_LEAD_NAME: '.'
  DEPARTMENT: '.'
  LEAD_ANALYSTS: '.'
  GROUP_LEAD: '.'
  CONTACT_EMAIL: '.'
  PIPELINE: '.'
  START_DATE: '.'
  COMPLETION_DATE: '.'
---

```{r logo-file, echo=FALSE}
attach(params)
# Insert logo on the top of the html report 
logo_file <- file.path(root_dir, "figures", "img", "DNB-BINF-Core-logo.png")
htmltools::img(src = knitr::image_uri(logo_file), alt = "logo", style = "position:absolute; top:0; left:0; padding:0px; height:120px;")
detach(params)
```

\addtolength{\headheight}{2.0cm} 
\fancypagestyle{plain}{} 
\thispagestyle{fancy}
\fancyhead[L]{\includegraphics[height=120px]{`r logo_file`}}
\renewcommand{\headrulewidth}{0pt}

<style type="text/css">
:root {--DNB_BINF_Core_color: #00427B;}

h1.title {margin-top: 130px;
          margin-bottom: 25px;
          font-size: 36px;}

.nobullet li {list-style-type: none;}

.reporthead {font-size: 20px;}

body { /* Normal */
  font-size: 16px;
  font-style: Arial, Helvetica, sans-serif;}

h1 {color: var(--DNB_BINF_Core_color);
    font-size: 28px;
    margin-top: 50px;}

h2 {color: var(--DNB_BINF_Core_color);
    font-size: 20px;}

.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
  background-color: var(--DNB_BINF_Core_color);}
</style>

<a href="https://wiki.stjude.org/display/CAB">

</a>

\pagebreak

<div class="reporthead"><br/>
**PI: `r params$PI_NAME`**  
**Project: `r params$PROJECT_NAME`**  
Task: `r params$TASK_ID`  
Project Lead(s): `r params$PROJECT_LEAD_NAME`  
Department: `r params$DEPARTMENT`  

<br />  

DNB Bioinformatics Core Analysis Team: 
<br />  

>**Lead Analyst(s): `r params$LEAD_ANALYSTS`**  
>Group Lead: `r params$GROUP_LEAD`  
<br />
>**Contact E-mail:** `r params$CONTACT_EMAIL`  
>**DNB Bioinformatics Core Pipeline:** `r params$PIPELINE`  

Date started: `r params$START_DATE`  
Date completed:  `r params$COMPLETION_DATE`  
Report generated: `r format(Sys.time(), '%H:%M:%S %Z %m/%d/%Y')` \

Reviewed by: _____________________   Date: ____________ \
</div>
\pagebreak
  
# Information about this notebook

This notebook:

- compute differential expression (DE) results for each cell type in the cohort,  and
- generate volcano plots to visualize and summarize DE patterns.

A volcano plot visualizes two key metrics for every gene:

- logâ‚‚ fold change (log2FC) â€” the magnitude and direction of expression change
- statistical significance â€” usually represented as â€“logâ‚â‚€(adjusted p-value)

By combining these two axes, volcano plots highlight genes that show both large expression changes and strong statistical support, making it easy to identify biologically meaningful upâ€‘ and downâ€‘regulated genes within each cell type.

## ðŸ” Interpretation Guidelines

**Up-regulated genes (red)**

Genes plotted in red meet all of the following criteria:

- log2FC > 0 (higher expression in Treatment vs Control)
- adjusted p-value â‰¤ Î± (statistically significant)
- Represent transcriptional programs increased or activated in the treatment condition for that specific cell type.

These genes may indicate:

- pathway activation
- treatment-induced responses
- cell-state transitions
- altered signaling or regulatory activity

**Down-regulated genes (blue)**

Genes plotted in blue meet all of the following criteria:

- log2FC < 0 (lower expression in Treatment vs Control)
- adjusted p-value â‰¤ Î±

These genes may represent:

- suppressed pathways
- inhibited regulatory programs
- decreased cell-typeâ€“specific functions
- loss of activity due to treatment or condition

**Non-significant genes (grey)**

Genes shown in grey are:

- not significant at the chosen adjusted p-value threshold (p_adj > Î±), and/or
- show only minor fold-change that does not meet the log2FC threshold.

These genes essentially represent background variation or small changes that are unlikely to be biologically meaningful under current criteria.


## ðŸ“Œ Summary

A volcano plot provides a fast and intuitive overview of differentialâ€‘expression (DE) patterns within each cell type.

### Color Guide

| **Color** | **Meaning**        | **Criteria**                               |
|-----------|---------------------|---------------------------------------------|
| **Red**   | Upâ€‘regulated        | log2FC > 0 & adjusted p-value â‰¤ Î±           |
| **Blue**  | Downâ€‘regulated      | log2FC < 0 & adjusted p-value â‰¤ Î±           |
| **Grey**  | Not significant     | adjusted p-value > Î± or \|log2FC\| below threshold |

This visualization helps identify genes that show both strong statistical significance and biologically meaningful foldâ€‘change in a cellâ€‘typeâ€“specific manner.


# Set up

```{r load-library, echo=TRUE}
attach(params)
suppressPackageStartupMessages({
  library(tidyverse)
  library(knitr)
  library(DT)
  library(glue)
  library(EnhancedVolcano)
  library(Seurat)
}) 
```

# Directories and paths to file Inputs/Outputs

```{r set-dir-and-file-names, echo=TRUE}
analysis_dir <- file.path(root_dir, "analyses", "de-go-analysis") 
module_results_dir <- file.path(analysis_dir, "results")
module_plots_dir <- file.path(analysis_dir, "plots")
data_dir <- file.path(root_dir, "analyses", "cell-types-annotation", "results", "cell_types_annotations_all")

# Input files
data_file <- file.path(data_dir, "seurat_obj_cell_types_annotations_all.rds")

# Create results_dir
results_dir <- file.path(module_results_dir, "01-de-volcano-plots")
if (!dir.exists(results_dir)) {
  dir.create(results_dir)}

# Create plots directory
plots_dir <- file.path(module_plots_dir, "01-de-volcano-plots") 
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)}
```

```{r echo=FALSE, warning=FALSE}
opts_chunk$set(fig.align='center',
               external=TRUE,
               echo=FALSE,
               warning=FALSE,
               fig.pos='H')
a4width <- 8.3
a4height <- 11.7
```

# Read seurat object

First, we will use the seurat object as generated from the pipeline in the `cell-types-annotation` module. 

```{r read-object, echo=TRUE}
seurat_obj <- readRDS(data_file)
DefaultAssay(seurat_obj) <- assay
```

# Finding differentially expressed features (cluster biomarkers) per cell type

Seurat can help find markers that define clusters via differential expression (DE). By default, it identifies positive and negative markers of a single cluster (specified in ident.1), compared to all other cells. [FindAllMarkers()](https://satijalab.org/seurat/reference/findallmarkers) automates this process for all clusters, but you can also test groups of clusters vs. each other, or against all cells. We save the table with all markers for each cluster at: <font size="3"><span style="color:blue">./results/01-de-volcano-plots/Res_``r {resolution_list}``_Markers_all.tsv.</span></font>\

We will explore DE per `r cell_type_label_go`. 

```{r find-markers-cell-type, echo=TRUE}
Idents(seurat_obj) <- seurat_obj@meta.data[[cell_type_label_go]] # Set Idents(seurat_obj) to match the group.by parameter you will use
table(Idents(seurat_obj)) # View cell identities, get summary table

all.markers <- FindAllMarkers(seurat_obj, assay = assay, logfc.threshold = 0.25, test.use = "wilcox", min.pct = 0.1, return.thresh = 0.01)
write.table(all.markers, file = paste(results_dir, "/", "Res_", resolution_list, "_Markers_all.tsv", sep = ""), sep = "\t", quote = FALSE, row.names = FALSE)
```

```{r find-markers-cell-type-interactive-table, echo=TRUE}
# Interactive Table
datatable(all.markers, 
          options = list(pageLength = 5, 
                         autoWidth = TRUE, 
                         server = TRUE), 
          filter = "top")
```

# Volcano Plot Per Cell Type

In this section, we visualize differential expression patterns by generating volcano plots for each cell type.  

The analysis focuses on the top `r n_value` genes ranked by significance to highlight the most biologically relevant upâ€‘ and downâ€‘regulated features.

```{r volcano-plot, fig.width = 8, fig.height = 6, fig.fullwidth = TRUE, echo=TRUE}
# ---- Optional: per-cluster volcano plots ----
group_col <- "cluster"        # change to your grouping column if different
stopifnot(group_col %in% names(all.markers))

by_grp <- split(all.markers, all.markers[[group_col]])
by_grp <- by_grp[order(names(by_grp))] #Sort alphabetically by group name

for (cl in names(by_grp)) {
  df <- by_grp[[cl]]

  # ---- Make sure we have gene symbols as labels (not numeric rownames) ----
  # Prefer a 'gene' column. If it exists, use it; otherwise try to derive from rownames
  if ("gene" %in% names(df)) {
    df$label <- as.character(df$gene)
  } else if (!is.null(rownames(df)) && any(nzchar(rownames(df)))) {
    # If rownames exist but might be numbers, still coerce to character
    df$label <- as.character(rownames(df))
  } else {
    warning("Skipping ", cl, ": no labels available.")
    next
  }

  # ---- Clamp p-values to avoid Inf ----
  eps <- 1e-300
  df$p_val_adj <- pmax(df$p_val_adj, eps)

  # ---- Pick top up/down by adj p and effect size ----
  up <- df %>%
    dplyr::filter(avg_log2FC >= 0.25) %>% #dplyr::filter(avg_log2FC > 0.25) %>% dplyr::arrange(p_val_adj)
    dplyr::arrange(p_val_adj, desc(avg_log2FC)) %>%
    slice_head(n = n_value)
  
  dn <- df %>%
    dplyr::filter(avg_log2FC <= -0.25) %>% # dplyr::filter(avg_log2FC < 0.25) 
    dplyr::arrange(p_val_adj, avg_log2FC) %>%
    slice_head(n = n_value)

  # Use gene labels for selection as well
  select_labels_grp <- unique(c(up$label, dn$label))
  
  # Optionally drop NAs
  select_labels_grp <- select_labels_grp[!is.na(select_labels_grp) & nzchar(select_labels_grp)]
  
  cat("Volcano Plot:", cl, "\n")
  p_grp <- print(EnhancedVolcano::EnhancedVolcano(
    df,
    lab            = df$label,            # <- gene names, not numbers
    x              = "avg_log2FC",
    y              = "p_val_adj",
    selectLab      = select_labels_grp,   # <- same label space as 'lab'
    drawConnectors = TRUE,
    parseLabels    = FALSE,     # If labels still parse as math, disable parsing:
    col            = c("black","black","black","red3"),     # Make significant points red only; others black
    pCutoff        = 5e-2,
    FCcutoff       = 0.25,
    title          = paste("Volcano Plot:", cl),
    subtitle       = NULL,
    ylab           = bquote(~-Log[10]~ 'P adj'),
    # Optional label/point tweaks
    labSize        = 3.3,
    pointSize      = 1.2,
    max.overlaps   = 25
  ))

  out_png_cl <- file.path(plots_dir, glue::glue("Volcano-plot-{cl}.png"))
  ggplot2::ggsave(filename = out_png_cl, plot = p_grp, width = 8, height = 6, dpi = 300)
}
```

```{r echo=FALSE}
detach(params)
```

\pagebreak

# Session Info

```{r echo=FALSE}
sessionInfo()
```

